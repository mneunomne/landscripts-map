<!DOCTYPE html>
<html>

<head>
	<title>Image Overlay on Google Maps</title>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyABc2FYPPzxrAMu_Atv1JQ5O_KrYBuXxQo"></script>
	<style>
		body {
			margin: 0;
			padding: 0;
			height: 100%;
			width: 100%;
		}

		#map {
			height: 100%;
			width: 100%;
			position: absolute;
		}
	</style>
	<script>
		const kmlRepo = 'https://raw.githubusercontent.com/mneunomne/landscripts-kml/main/';
		let map;
		let isAnimating = false;
		let pathCoordinates = []; // Array to store the path coordinates
		let polyline; // Variable to hold the Polyline object

		function initMap() {
			// Define the bounds using the given lat/lng values
			const imageBounds = {
				north: -22.32638056,  // maxLat
				south: -22.40520000,  // minLat
				east: -43.01715833,   // maxLng
				west: -43.10237778    // minLng
			};

			// Create a map centered within the bounds
			map = new google.maps.Map(document.getElementById("map"), {
				center: { lat: (-22.40520000 + -22.32638056) / 2, lng: (-43.10237778 + -43.01715833) / 2 },
				zoom: 16,
				disableDefaultUI: true
			});

			// Specify the image to use as the overlay
			const imageUrl = 'perfect_bounds.jpg';

			// Create the ground overlay
			const overlay = new google.maps.GroundOverlay(imageUrl, imageBounds);

			// Add the overlay to the map
			overlay.setMap(map);

			// Set satellite view
			map.setMapTypeId('satellite');

			const barreiras = new google.maps.KmlLayer({
				url: kmlRepo + 'barreiras.kml',
				map: map,
				preserveViewport: true
			});

			// Initialize the Polyline with an empty path
			polyline = new google.maps.Polyline({
				path: pathCoordinates,
				geodesic: true,
				strokeColor: '#0000FFF0',
				strokeOpacity: 1.0,
				strokeWeight: 2
			});

			// Add the polyline to the map
			polyline.setMap(map);
		}

		function smoothPanTo(target) {
			if (isAnimating) return;

			const currentCenter = map.getCenter();
			const startLat = currentCenter.lat();
			const startLng = currentCenter.lng();
			const endLat = target.lat;
			const endLng = target.lng;
			const duration = Math.random() * 10000 + 1000; // Duration of the animation in milliseconds
			const frameRate = 30; // Frames per second
			const totalFrames = Math.round((duration / 1000) * frameRate);
			let currentFrame = 0;

			isAnimating = true;

			function animate() {
				currentFrame++;
				const progress = easeInOutQuad(currentFrame / totalFrames);
				const lat = startLat + (endLat - startLat) * progress;
				const lng = startLng + (endLng - startLng) * progress;
				map.setCenter(new google.maps.LatLng(lat, lng));

				if (currentFrame < totalFrames) {
					requestAnimationFrame(animate);
				} else {
					isAnimating = false;
				}
			}

			animate();
		}

		// Easing function for smooth animation
		function easeInOutQuad(t) {
			return t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;
		}

		// WebSocket integration
		const socket = new WebSocket('ws://localhost:8080/');

		// When a message is received from the server
		socket.onmessage = function (event) {
			const position = JSON.parse(event.data);
			const latLng = new google.maps.LatLng(position.lat, position.lng);

			// Add the new position to the pathCoordinates array
			pathCoordinates.push(latLng);

			// Update the polyline path with the new coordinates
			polyline.setPath(pathCoordinates);

			// Smoothly pan the map to the new position
			smoothPanTo(position);
		};
	</script>
</head>

<body onload="initMap()">
	<div id="map" style="height: 100%; width: 100%;"></div>
</body>

</html>
